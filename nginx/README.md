# README: –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Nginx

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenResty –∏ Lua. –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî –æ–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º JWT (JSON Web Tokens) –∏ Redis –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á—ë—Ä–Ω—ã–º —Å–ø–∏—Å–∫–æ–º —Ç–æ–∫–µ–Ω–æ–≤.

---

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **JWT (JSON Web Tokens)**:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
   - –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ HTTP-only –∫—É–∫–∞—Ö –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

2. **Redis**:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —á—ë—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∏ logout.

3. **Nginx + OpenResty**:
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫—É–∫–∞–º–∏.
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Lua –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –ª–æ–≥–∏–∫–∏.

---

## –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã

### 1. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (Login)**

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ `/auth/login` —Å —É—á—ë—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å).
- –ë—ç–∫–µ–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–≤–∞ —Ç–æ–∫–µ–Ω–∞:
  - **Access Token**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º —Ä–µ—Å—É—Ä—Å–∞–º.
  - **Refresh Token**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Access Token.
- –¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ HTTP-only –∫—É–∫–∞—Ö:
  - `access_token` ‚Äî –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API.
  - `refresh_token` ‚Äî –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤.

### 2. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Access Token)**

- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º —Ä–µ—Å—É—Ä—Å–∞–º (`/api/*`) Nginx –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å Access Token:
  1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞**:
     - –¢–æ–∫–µ–Ω –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ –∫—É–∫–∏ `access_token`.
  2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—ë—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞**:
     - –¢–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤ —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ –≤ Redis.
  3. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞**:
     - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—å —Ç–æ–∫–µ–Ω–∞ –∏ —Å—Ä–æ–∫ –µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è (`exp`).
  4. **–î–æ—Å—Ç—É–ø –∫ —Ä–µ—Å—É—Ä—Å–∞–º**:
     - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –Ω–∞ –±—ç–∫–µ–Ω–¥.
     - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ `401 Unauthorized`.

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (Refresh Token)**

- –ï—Å–ª–∏ Access Token –∏—Å—Ç—ë–∫, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ `/auth/refresh` —Å Refresh Token.
- –ë—ç–∫–µ–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Refresh Token –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π Access Token.

### 4. **–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã (Logout)**

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ `/api/auth/logout`.
- Nginx –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
  1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫**:
     - Access Token –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ Redis —Å TTL, —Ä–∞–≤–Ω—ã–º –æ—Å—Ç–∞–≤—à–µ–º—É—Å—è –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—è `exp`).
  2. **–û—á–∏—Å—Ç–∫–∞ –∫—É–∫**:
     - –ö—É–∫–∏ `access_token` –∏ `refresh_token` –æ—á–∏—â–∞—é—Ç—Å—è.
  3. **–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥**:
     - –ó–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–¥–∞–ª–µ–Ω–∏–µ Refresh Token –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö).

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx

### –û—Å–Ω–æ–≤–Ω—ã–µ –±–ª–æ–∫–∏

1. **`location /`**:
   - –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥.

2. **`location /api/auth/logout`**:
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.
   - –î–æ–±–∞–≤–ª—è–µ—Ç Access Token –≤ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ Redis.
   - –û—á–∏—â–∞–µ—Ç –∫—É–∫–∏ `access_token` –∏ `refresh_token`.

3. **`location /api`**:
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ API.
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Access Token –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏ –Ω–∞–ª–∏—á–∏–µ –≤ —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ.

### Lua-—Å–∫—Ä–∏–ø—Ç—ã

- **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞**:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `resty.jwt` –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT.
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—å —Ç–æ–∫–µ–Ω–∞, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏ –Ω–∞–ª–∏—á–∏–µ –≤ —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ.

- **–†–∞–±–æ—Ç–∞ —Å Redis**:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `resty.redis` –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á—ë—Ä–Ω—ã–º —Å–ø–∏—Å–∫–æ–º.

---

## –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### 1. **–õ–æ–≥–∏–Ω**
```http
POST /auth/login
Content-Type: application/json

{
  "username": "user",
  "password": "password"
}
```

**–û—Ç–≤–µ—Ç:**
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫—É–∫–∏ `access_token` –∏ `refresh_token`.

### 2. **–î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º—É —Ä–µ—Å—É—Ä—Å—É**
```http
GET /api/protected
Cookie: access_token=<JWT>
```

**–û—Ç–≤–µ—Ç:**
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å.
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ `401 Unauthorized`.

### 3. **–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã**
```http
POST /api/auth/logout
Cookie: access_token=<JWT>; refresh_token=<JWT>
```

**–û—Ç–≤–µ—Ç:**
- –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫.
- –ö—É–∫–∏ `access_token` –∏ `refresh_token` –æ—á–∏—â–∞—é—Ç—Å—è.

---

## –ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤

- **–•—Ä–∞–Ω–µ–Ω–∏–µ**:
  - –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis —Å –∫–ª—é—á–æ–º `blacklist:<—Ç–æ–∫–µ–Ω>`.
- **TTL**:
  - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∑–∞–ø–∏—Å–∏ –≤ Redis —Ä–∞–≤–Ω–æ –æ—Å—Ç–∞–≤—à–µ–º—É—Å—è –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—è `exp`).
- **–û—á–∏—Å—Ç–∫–∞**:
  - –ó–∞–ø–∏—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ Redis –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è.

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **OpenResty**: Nginx —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Lua.
- **Lua-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏**:
  - `resty.jwt`: –î–ª—è —Ä–∞–±–æ—Ç—ã —Å JWT.
  - `resty.redis`: –î–ª—è —Ä–∞–±–æ—Ç—ã —Å Redis.
- **Redis**: –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —á—ë—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤.

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–î–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º JWT –∏ Redis. –û–Ω–∞ –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞. –ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º. üòä